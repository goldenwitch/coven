name: promote

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Semver bump to compute from build/VERSION"
        required: true
        default: patch
        type: choice
        options: [patch, minor, major]

permissions:
  contents: write

concurrency:
  group: promote-${{ github.ref_name }}
  cancel-in-progress: false

jobs:
  build-pack-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (full history + tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Setup .NET SDK (10 GA)
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'ga'

      

      - name: Plan release (version and selection)
        id: plan
        shell: bash
        run: |
          set -euo pipefail
          base=$(tr -d '\r\n' < build/VERSION)
          bump="${{ inputs.bump }}"
          IFS='.' read -r MA MI PA <<< "${base%%-*}"
          MA=${MA:-0}; MI=${MI:-0}; PA=${PA:-0}
          case "$bump" in
            major) MA=$((MA+1)); MI=0; PA=0 ;;
            minor) MI=$((MI+1)); PA=0 ;;
            patch|*) PA=$((PA+1)) ;;
          esac
          version="$MA.$MI.$PA"
          echo "version=$version" >> "$GITHUB_OUTPUT"

          paths=$(jq -r '.packages[].path' build/packages.manifest.json | paste -sd, -)
          echo "paths=$paths" >> "$GITHUB_OUTPUT"

          prev=$(git tag --list 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sed 's/^v//' | sort -V | tail -n1 || true)
          echo "prev=$prev" >> "$GITHUB_OUTPUT"

      - name: Validate version monotonicity
        shell: bash
        run: |
          set -euo pipefail
          new="${{ steps.plan.outputs.version }}"
          prev="${{ steps.plan.outputs.prev }}"
          if [[ -n "$prev" ]]; then
            max=$(printf '%s\n%s\n' "$prev" "$new" | sort -V | tail -n1)
            if [[ "$max" != "$new" ]]; then
              echo "Requested version $new must be greater than previous stable $prev" >&2
              exit 1
            fi
            if [[ "$new" == "$prev" ]]; then
              echo "Requested version $new equals previous stable $prev; must be greater." >&2
              exit 1
            fi
          fi


      - name: Pack stable
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts/nupkg
          version="${{ steps.plan.outputs.version }}"
      
          IFS=',' read -ra dirs <<< "${{ steps.plan.outputs.paths }}"
          shopt -s nullglob
          for d in "${dirs[@]}"; do
            d="${d//[$'\r\n']/}"
            [[ -z "$d" ]] && continue
      
            for csproj in "$d"/*.csproj; do
              echo "Packing: $csproj"
              dotnet pack "$csproj" -c Release -o artifacts/nupkg \
                /p:Version="$version" \
                /p:ContinuousIntegrationBuild=true \
                /p:IncludeSymbols=true \
                /p:SymbolPackageFormat=snupkg
            done
          done


      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nupkgs-stable
          path: artifacts/nupkg/*
          if-no-files-found: error

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.plan.outputs.version }}
          name: v${{ steps.plan.outputs.version }}
          prerelease: false
          draft: false
          generate_release_notes: true
          files: |
            artifacts/nupkg/*.nupkg
            artifacts/nupkg/*.snupkg

      - name: Publish to NuGet.org
        if: ${{ secrets.NUGET_API_KEY != '' }}
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          dotnet nuget push "artifacts/nupkg/*.nupkg" --skip-duplicate --api-key "$NUGET_API_KEY" --source https://api.nuget.org/v3/index.json
